generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DisputeStatus {
  CREATING  // 占位状态，正在创建链上争议
  VOTING
  RESOLVED
}

enum DisputeResult {
  SUPPORT_AGENT
  SUPPORT_USER
}

enum CallbackStatus {
  PENDING
  SENT
  FAILED
}

model Platform {
  id            String    @id
  name          String
  tokenContract String
  minBalance    String
  chainId       Int
  description   String?
  webhookUrl    String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  disputes      Dispute[]

  @@index([tokenContract])
}

model Dispute {
  id                 String          @id @default(uuid())
  platformDisputeId  String          @unique
  platformId         String?         // 关联平台ID（nullable for backward compatibility）
  jobId              String
  billId             String
  agentId            String
  initiator          String
  reason             String
  evidenceUri        String?
  chainId            Int
  contractAddress    String
  contractDisputeId  BigInt
  deadline           DateTime
  status             DisputeStatus
  result             DisputeResult?
  votesAgent         Int             @default(0)
  votesUser          Int             @default(0)
  finalizeTxHash     String?
  callbackStatus     CallbackStatus  @default(PENDING)
  callbackAttempts   Int             @default(0)
  callbackNextAttemptAt DateTime?
  callbackLastError  String?
  tokenAddress       String?
  minBalance         String?
  platform           Platform?       @relation(fields: [platformId], references: [id], onDelete: SetNull)
  votes              Vote[]
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@index([contractDisputeId])
  @@index([status, deadline])
  @@index([platformId])
}

model Vote {
  id          String  @id @default(uuid())
  disputeId   String
  voter       String
  choice      Int
  txHash      String
  blockNumber Int
  dispute     Dispute @relation(fields: [disputeId], references: [id])

  @@unique([disputeId, voter])
}

model IndexerCheckpoint {
  id            String   @id @default("singleton")
  lastBlock     Int
  lastBlockHash String?
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())
}
